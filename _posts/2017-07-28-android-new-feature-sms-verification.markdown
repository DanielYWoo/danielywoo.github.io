---
layout: post
title:  "Android 8的安全新特性:下行短信验证"
date:   2017-07-28 17:33:00
published: true
---

目前通过下行短信验证码来验证手机号码来完成注册是非常常用的手段，尽管他的安全性存在一定问题，但是下行短信验证在短期内仍然是在安全和体验方面比较比较平衡的选择。

(去年NIST已经不再推荐下行短信两阶段验证，今年运营商O2 Telefonica在德国已经出现了通过SS7漏洞对银行的二次短信验证攻击成功并转账的案例)

尽管下行短信已经很方便了，但是我们还是想让这个流程更加流畅，那就是避免用户手动输入或者复制短信中的验证代码。不过这样就得增加READ_SMS的权限然后读取用户的短信，这其实有很大的安全问题。首先，很多用户对于短信读取权限是很敏感的，另外，如果每个应用都有读取短信的权限，那么这些应用可以同时读取用户的短信，这就会造成短信验证码被恶意的应用盗取。

为了解决这个体验和安全两方面的问题，这个流程在android 8中得到了很好的优化，用户整个过程不再需要手动输入或者复制短信验证码，也不需要应用增加READ_SMS权限。具体的做法如下：

第一步，客户端先通过SmsManager的createAppSpecificSmsToken方法来创建一个一次性的token, 操作系统记录这个token是哪个app发起的，然后把这个token和手机号提交给服务器。
第二步，服务器把生成有效期为几分钟的code，然后把手机号和token映射到这个code，然后向短信网关发短信，内容为"token + code"。
第三步，客户端操作系统接收到这条短信后，识别出token，然后通过包含短信内容的Intent通知所对应的应用，这个过程其它应用不会收到通知并且这条短信也不会进入短信信箱。
第四步，客户端收到Intent后向服务器提交code，完成验证。

<img src="/images/2017-07-28/sms_verification_seq.png" max-height="500px">


需要注意的是，这个过程中用户全程没有文本操作，所以体验更加流畅。另外，这条短信不进入信箱，其他具有READ_SMS权限的应用无法读取到这个短信，而且操作系统只会把内容发给token对应的应用，所以会比READ_SMS的方式要安全很多。目前Android 8还是preview阶段，所以这个token是不会过期的，只是每次生成新token都会让老token失效，等Android 8正式发布的时候这个token的有效期可能会限定很短。



